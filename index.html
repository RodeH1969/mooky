<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Mooky Cloud Camera</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .app-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            width: 95%;
            max-width: 95vw;
            min-height: 95vh;
        }

        .setup-section {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: left;
            border: 3px solid #ff6b9d;
            box-shadow: 0 10px 25px rgba(255, 107, 157, 0.3);
        }

        .setup-section h3 {
            color: #2d3436;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }

        .setup-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #2d3436;
            font-size: 1.1em;
        }

        .setup-section input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ff6b9d;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
        }

        .setup-section input:focus {
            outline: none;
            border-color: #ff3867;
            box-shadow: 0 0 10px rgba(255, 107, 157, 0.3);
            transform: translateY(-2px);
        }

        .setup-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .setup-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        .cloud-status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1em;
        }

        .cloud-status.connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .cloud-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .sponsor-banner {
            background: linear-gradient(45deg, #2196F3, #4CAF50, #FF9800, #F44336, #2196F3);
            background-size: 400% 400%;
            animation: sponsorGlow 4s ease-in-out infinite;
            border-radius: 10px;
            padding: 12px;
            margin: 20px auto 0 auto;
            border: 2px solid #FF6347;
            box-shadow: 0 5px 15px rgba(255, 99, 71, 0.3);
            text-align: center;
            position: relative;
            overflow: hidden;
            width: 33.33%;
            max-width: 100vw;
        }

        .sponsor-banner::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff6b9d, #ffd93d, #6bcf7f, #4d9de0, #ff6b9d);
            background-size: 400% 400%;
            animation: borderGlow 3s ease-in-out infinite;
            z-index: -1;
            border-radius: 20px;
        }

        @keyframes borderGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes sponsorGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .sponsor-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        .sponsor-logo {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        }

        .sponsor-logo svg {
            width: 225px;
            height: 225px;
        }

        .sponsor-info {
            flex: 1;
            text-align: left;
            min-width: 300px;
        }

        .sponsor-header {
            color: #FF6347;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 6px;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }

        .sponsor-name {
            font-size: 2.4em;
            font-weight: 900;
            color: #2196F3;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.9);
            margin-bottom: 6px;
        }

        .sponsor-tagline {
            font-size: 1.3em;
            color: #4CAF50;
            font-weight: 600;
            margin-bottom: 8px;
            font-style: italic;
        }

        .sponsor-details {
            font-size: 1.1em;
            color: #333;
            font-weight: 500;
        }

        .sponsor-website {
            color: #2196F3;
            text-decoration: none;
            font-weight: bold;
        }

        .sponsor-website:hover {
            text-decoration: underline;
        }

        @keyframes sponsorPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .header-section {
            margin-bottom: 30px;
        }

        .app-title {
            font-size: 110em;
            color: #667eea;
            font-weight: 900;
            margin-bottom: 30px;
            font-family: 'Trebuchet MS', 'Impact', 'Arial Black', cursive, sans-serif;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.3), 0 0 20px rgba(102, 126, 234, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 18px;
            letter-spacing: 5px;
            position: relative;
        }

        .letter {
            display: inline-block;
            animation: bounce 2s ease-in-out infinite;
            color: #667eea;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.3), 0 0 15px rgba(102, 126, 234, 0.6);
        }

        .letter:nth-child(1) { animation-delay: 0s; }
        .letter:nth-child(2) { animation-delay: 0.1s; }
        .letter:nth-child(3) { animation-delay: 0.2s; }
        .letter:nth-child(4) { animation-delay: 0.3s; }
        .letter:nth-child(5) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-15px);
            }
            60% {
                transform: translateY(-8px);
            }
        }

        .bean-o {
            display: inline-block;
            width: 1em;
            height: 1.28em;
            position: relative;
            top: 0.15em;
            margin: 0 0.08em;
            animation: bounce 2s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
        }

        /* First bean bounces with second letter timing */
        .bean-o:nth-of-type(1) {
            animation-delay: 0.1s;
        }

        /* Second bean bounces with fourth letter timing */
        .bean-o:nth-of-type(2) {
            animation-delay: 0.2s;
        }

        .promo-text {
            color: #444;
            margin: 0 auto 35px auto;
            font-size: 3.2em;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 20px 20px;
            border-radius: 15px;
            border: 3px solid #ffc107;
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3);
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
            width: 16.67%;
        }

        .coffee-cup {
            display: inline-block;
            position: relative;
            width: 56px;
            height: 72px;
            background: linear-gradient(to bottom, #8B4513 0%, #A0522D 50%, #8B4513 100%);
            border-radius: 0 0 20px 20px;
            margin-left: 10px;
        }

        .coffee-cup::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -6px;
            right: -6px;
            height: 20px;
            background: #654321;
            border-radius: 50% 50% 0 0;
            border: 4px solid #654321;
        }

        .coffee-cup::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -20px;
            width: 16px;
            height: 24px;
            border: 4px solid #8B4513;
            border-left: none;
            border-radius: 0 50% 50% 0;
        }

        .steam {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: #ddd;
            letter-spacing: 4px;
            animation: steam-rise 3s ease-in-out infinite;
            text-shadow: 0 0 6px rgba(255,255,255,0.5);
        }

        @keyframes steam-rise {
            0%, 100% { 
                opacity: 0.8; 
                transform: translateX(-50%) translateY(0px) scale(1);
            }
            33% { 
                opacity: 0.6; 
                transform: translateX(-48%) translateY(-8px) scale(1.1);
            }
            66% { 
                opacity: 0.4; 
                transform: translateX(-52%) translateY(-16px) scale(0.9);
            }
        }

        .camera-container {
            position: relative;
            margin-bottom: 30px;
        }

        #video {
            width: 100%;
            max-width: 900px;
            height: auto;
            max-height: 450px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            background: #f0f0f0;
            object-fit: cover;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }

        #canvas {
            display: none;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 22px 40px;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            min-height: 65px;
            min-width: 160px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        button:hover, button:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            outline: none;
        }

        button:active {
            transform: translateY(0);
            transition: all 0.1s ease;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .capture-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            font-size: 1.3em;
            padding: 25px 25px;
            min-height: 75px;
            min-width: 320px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-wrap: wrap;
            text-align: center;
            line-height: 1.2;
            color: white;
        }

        .capture-btn .mooky-word {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            font-weight: 900;
            color: #4169E1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            font-size: 1.2em;
            background: rgba(255,255,255,0.95);
            padding: 3px 8px;
            border-radius: 8px;
            margin: 0 3px;
            letter-spacing: 1px;
        }

        .capture-btn:hover, .capture-btn:focus {
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .visit-tracker {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            border-radius: 15px;
            color: white;
            text-align: center;
            display: none;
        }

        .visit-tracker h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .day-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 auto;
            transition: all 0.3s ease;
        }

        .day-circle.visited {
            background: #00b894;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(0, 184, 148, 0.6);
        }

        .winner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(45deg, #ff6b9d, #ffd93d, #6bcf7f, #4d9de0, #9b59b6);
            background-size: 400% 400%;
            animation: winnerBackground 2s ease-in-out infinite;
            display: none;
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }

        .admin-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }

        .admin-title {
            font-size: 2.5em;
            color: #667eea;
            font-weight: bold;
        }

        .admin-close {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
        }

        .admin-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
        }

        .admin-section h3 {
            color: #2d3436;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .face-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .face-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            background: #f9f9f9;
        }

        .face-card img {
            width: 100%;
            max-width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .face-info {
            font-size: 0.9em;
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .test-section {
            background: #e8f5e8;
            border: 2px solid #00b894;
        }

        @keyframes winnerBackground {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .winner-content {
            text-align: center;
            animation: winnerPulse 1s ease-in-out infinite;
        }

        @keyframes winnerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .winner-title {
            font-size: 4em;
            font-weight: 900;
            color: white;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            animation: titleBounce 0.8s ease-in-out infinite alternate;
            font-family: 'Trebuchet MS', 'Impact', 'Arial Black', cursive, sans-serif;
        }

        @keyframes titleBounce {
            from { transform: translateY(0px); }
            to { transform: translateY(-10px); }
        }

        .winner-message {
            font-size: 2.2em;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.3);
            padding: 25px;
            border-radius: 20px;
            border: 3px solid white;
            max-width: 600px;
            line-height: 1.3;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffd93d;
            animation: confettiFall 3s linear infinite;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Hide cloud setup on mobile and tablets */
        @media (max-width: 1024px), (pointer: coarse) {
            .setup-section {
                display: none;
            }
        }
        
        /* Specifically hide cloud setup on touch devices */
        @media (hover: none) and (pointer: coarse) {
            .setup-section {
                display: none;
            }
        }

        /* Mobile Responsive - Fill whole screen */
        @media (max-width: 600px) {
            body { padding: 2px; min-height: 100vh; }
            .app-container { padding: 10px 8px; border-radius: 12px; width: 98%; min-height: 98vh; }
            .app-title { font-size: 66em; margin-bottom: 15px; gap: 10px; letter-spacing: 3px; }
            .bean-o { width: 1em; height: 1.28em; top: 0.15em; margin: 0 0.08em; }
            .promo-text { font-size: 2.8em; margin: 0 auto 20px auto; padding: 6px 12px; flex-direction: column; gap: 6px; width: 90%; }
            .coffee-cup { width: 50px; height: 64px; }
            .camera-container { margin-bottom: 15px; }
            #video { max-height: 400px; }
            .controls { flex-direction: column; align-items: center; gap: 12px; margin-bottom: 15px; }
            button { width: 100%; max-width: 340px; font-size: 1.3em; padding: 22px 38px; min-height: 68px; }
            .capture-btn { font-size: 1.3em; padding: 25px 25px; min-height: 78px; min-width: auto; max-width: 340px; }
            .capture-btn .mooky-word { font-size: 1.3em; }
            .winner-title { font-size: 3.2em; }
            .winner-message { font-size: 1.6em; padding: 20px; }
            
            /* Mobile sponsor banner - at bottom, smaller */
            .sponsor-banner { margin: 15px auto 0 auto; padding: 8px; width: 90%; }
            .sponsor-content { flex-direction: column; text-align: center; gap: 8px; padding: 16px; }
            .sponsor-logo { width: 240px; height: 240px; margin: 0 auto; }
            .sponsor-logo svg { width: 180px; height: 180px; }
            .sponsor-info { text-align: center; min-width: auto; }
            .sponsor-header { font-size: 1.0em; }
            .sponsor-name { font-size: 1.6em; }
            .sponsor-tagline { font-size: 1.0em; }
            .sponsor-details { font-size: 0.9em; }
        }

        /* iPad/Tablet Responsive - Fill screen portrait */
        @media (min-width: 601px) and (max-width: 1024px) {
            body { 
                padding: 0px; 
                min-height: 100vh; 
                margin: 0;
            }
            .app-container { 
                padding: 8px 5px; 
                width: 100%; 
                min-height: 100vh; 
                margin: 0;
                border-radius: 0px;
                box-shadow: none;
            }
            .app-title { 
                font-size: 35em; 
                margin-bottom: 10px; 
                line-height: 0.8;
            }
            .bean-o { 
                width: 1em; 
                height: 1.28em; 
                margin: 0 0.08em;
            }
            .promo-text { 
                margin: 0 auto 15px auto; 
                font-size: 1.4em; 
                padding: 3px 15px; 
                width: 50%;
            }
            .coffee-cup { width: 32px; height: 42px; }
            .camera-container { 
                margin-bottom: 15px; 
            }
            #video { 
                max-height: 320px; 
                width: 95%;
                min-height: 260px;
            }
            .controls { 
                margin-bottom: 10px; 
            }
            button { 
                font-size: 1.4em; 
                padding: 20px 40px; 
                min-height: 60px; 
            }
            .capture-btn { 
                padding: 25px 25px; 
                min-height: 70px; 
                font-size: 1.4em; 
                min-width: 320px; 
            }
            .capture-btn .mooky-word { 
                font-size: 1.2em; 
            }
            
            /* iPad sponsor banner - centered and compact */
            .sponsor-banner { 
                margin: 10px auto 0 auto; 
                padding: 12px; 
                text-align: center;
                width: 80%;
            }
            .sponsor-content { 
                padding: 24px; 
                justify-content: center;
                text-align: center;
            }
            .sponsor-info {
                text-align: center;
                min-width: auto;
            }
            .sponsor-logo { 
                width: 240px; 
                height: 240px; 
                margin: 0 auto;
            }
            .sponsor-logo svg { 
                width: 180px; 
                height: 180px; 
            }
            .sponsor-header { 
                font-size: 1.1em; 
            }
            .sponsor-name { 
                font-size: 1.8em; 
            }
            .sponsor-tagline { 
                font-size: 1.1em; 
            }
            .sponsor-details { 
                font-size: 0.9em; 
            }
        }

        /* iPad/Tablet Landscape */
        @media (min-width: 601px) and (max-width: 1024px) and (orientation: landscape) {
            .app-title { font-size: 18em; margin-bottom: 18px; }
            #video { max-height: 240px; }
            .promo-text { font-size: 3.0em; padding: 4px; }
            .coffee-cup { width: 44px; height: 58px; }
            .sponsor-banner { margin-top: 15px; padding: 8px; width: 50%; }
            button { font-size: 1.3em; padding: 22px 35px; min-height: 66px; }
            .capture-btn { padding: 25px 25px; min-height: 76px; font-size: 1.3em; }
        }
            .app-container { padding: 15px 10px; border-radius: 10px; }
            .app-title { font-size: 7.8em; gap: 4px; letter-spacing: 1px; }
            .bean-o { width: 1em; height: 1.28em; top: 0.15em; margin: 0 0.08em; }
            .promo-text { font-size: 1.6em; margin-bottom: 20px; }
            .coffee-cup { width: 44px; height: 58px; }
            .winner-title { font-size: 2em; }
            .winner-message { font-size: 1.1em; padding: 15px; }
        }

        @media (orientation: landscape) and (max-height: 600px) {
            body { padding: 10px; }
            .app-container { padding: 15px; margin: 5px 0; }
            .header-section { margin-bottom: 20px; }
            .app-title { font-size: 8.8em; margin-bottom: 12px; gap: 6px; }
            .bean-o { width: 45px; height: 58px; top: 8px; }
            .promo-text { margin-bottom: 15px; font-size: 0.9em; flex-direction: row; gap: 5px; }
            .camera-container { margin-bottom: 15px; }
            .controls { gap: 10px; margin-bottom: 10px; }
            button { padding: 12px 25px; font-size: 0.9em; min-height: 40px; }
            .capture-btn { padding: 15px 20px; font-size: 0.8em; min-height: 45px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- CLOUD SETUP SECTION - Hidden on mobile -->
        <div class="setup-section" id="setupSection">
            <h3>‚òÅÔ∏è CLOUD SETUP - START HERE!</h3>
            
            <label for="firebaseConfig">üî• Firebase Config (JSON):</label>
            <input type="text" id="firebaseConfig" placeholder='Paste your Firebase config JSON here...'/>
            
            <label for="visionApiKey">üëÅÔ∏è Google Vision API Key:</label>
            <input type="text" id="visionApiKey" placeholder="Paste your Vision API key here..."/>
            
            <button class="setup-btn" onclick="setupCloud()">üöÄ CONNECT TO CLOUD</button>
            
            <div id="cloudStatus" class="cloud-status disconnected">
                ‚ùå Not connected to cloud services - Enter your keys above!
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; font-size: 0.9em; color: #856404;">
                <strong>Admin Access:</strong> Press <kbd>Ctrl+Alt+A</kbd> to open admin panel and view face recognition results.
            </div>
        </div>

        <div class="header-section">
            <h1 class="app-title">
                <span class="letter">m</span>
                <div class="bean-o">
                    <svg viewBox="0 0 300 400" xmlns="http://www.w3.org/2000/svg">
                      <defs>
                        <radialGradient id="glow1" cx="50%" cy="50%" r="50%">
                          <stop offset="0%" style="stop-color:#FFE4B5;stop-opacity:0.8" />
                          <stop offset="100%" style="stop-color:#FFF8DC;stop-opacity:0.3" />
                        </radialGradient>
                        <linearGradient id="beanGradient1" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" style="stop-color:#8B4513" />
                          <stop offset="50%" style="stop-color:#A0522D" />
                          <stop offset="100%" style="stop-color:#654321" />
                        </linearGradient>
                        <filter id="shadow1" x="-50%" y="-50%" width="200%" height="200%">
                          <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                          <feOffset dx="2" dy="2" result="offset"/>
                          <feComponentTransfer>
                            <feFuncA type="linear" slope="0.3"/>
                          </feComponentTransfer>
                          <feMerge> 
                            <feMergeNode/>
                            <feMergeNode in="SourceGraphic"/> 
                          </feMerge>
                        </filter>
                      </defs>
                      <circle cx="150" cy="200" r="180" fill="url(#glow1)" />
                      <g stroke="#FFD700" stroke-width="3" opacity="0.6">
                        <line x1="150" y1="20" x2="150" y2="60" />
                        <line x1="230" y1="50" x2="210" y2="80" />
                        <line x1="280" y1="120" x2="250" y2="130" />
                        <line x1="290" y1="200" x2="250" y2="200" />
                        <line x1="280" y1="280" x2="250" y2="270" />
                        <line x1="230" y1="350" x2="210" y2="320" />
                        <line x1="150" y1="380" x2="150" y2="340" />
                        <line x1="70" y1="350" x2="90" y2="320" />
                        <line x1="20" y1="280" x2="50" y2="270" />
                        <line x1="10" y1="200" x2="50" y2="200" />
                        <line x1="20" y1="120" x2="50" y2="130" />
                        <line x1="70" y1="50" x2="90" y2="80" />
                      </g>
                      <ellipse cx="150" cy="200" rx="70" ry="100" fill="url(#beanGradient1)" filter="url(#shadow1)" />
                      <path d="M 150 120 Q 140 150 150 180 Q 160 210 150 280" 
                            stroke="#654321" stroke-width="4" fill="none" />
                      <g>
                        <ellipse cx="125" cy="170" rx="12" ry="15" fill="white" />
                        <circle cx="127" cy="172" r="8" fill="black" />
                        <circle cx="130" cy="169" r="3" fill="white" />
                        <ellipse cx="175" cy="170" rx="12" ry="15" fill="white" />
                        <circle cx="173" cy="172" r="8" fill="black" />
                        <circle cx="176" cy="169" r="3" fill="white" />
                        <circle cx="122" cy="165" r="1.5" fill="white" opacity="0.8" />
                        <circle cx="178" cy="165" r="1.5" fill="white" opacity="0.8" />
                      </g>
                      <path d="M 120 220 Q 150 250 180 220" 
                            stroke="white" stroke-width="6" fill="none" stroke-linecap="round" />
                      <path d="M 115 215 Q 150 255 185 215" 
                            stroke="#FFD700" stroke-width="3" fill="none" stroke-linecap="round" opacity="0.7" />
                      <ellipse cx="105" cy="200" rx="8" ry="6" fill="#FF69B4" opacity="0.3" />
                      <ellipse cx="195" cy="200" rx="8" ry="6" fill="#FF69B4" opacity="0.3" />
                      <g fill="#FFD700" opacity="0.8">
                        <polygon points="100,140 102,144 106,144 103,147 104,151 100,149 96,151 97,147 94,144 98,144" />
                        <polygon points="200,140 202,144 206,144 203,147 204,151 200,149 196,151 197,147 194,144 198,144" />
                        <polygon points="80,240 82,244 86,244 83,247 84,251 80,249 76,251 77,247 74,244 78,244" />
                        <polygon points="220,240 222,244 226,244 223,247 224,251 220,249 216,251 217,247 214,244 218,244" />
                      </g>
                      <g fill="white" opacity="0.9">
                        <circle cx="110" cy="120" r="2" />
                        <circle cx="190" cy="130" r="1.5" />
                        <circle cx="85" cy="180" r="1" />
                        <circle cx="215" cy="190" r="1.5" />
                        <circle cx="95" cy="280" r="2" />
                        <circle cx="205" cy="290" r="1" />
                      </g>
                    </svg>
                </div>
                <div class="bean-o">
                    <svg viewBox="0 0 300 400" xmlns="http://www.w3.org/2000/svg">
                      <defs>
                        <radialGradient id="glow2" cx="50%" cy="50%" r="50%">
                          <stop offset="0%" style="stop-color:#FFE4B5;stop-opacity:0.8" />
                          <stop offset="100%" style="stop-color:#FFF8DC;stop-opacity:0.3" />
                        </radialGradient>
                        <linearGradient id="beanGradient2" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" style="stop-color:#8B4513" />
                          <stop offset="50%" style="stop-color:#A0522D" />
                          <stop offset="100%" style="stop-color:#654321" />
                        </linearGradient>
                        <filter id="shadow2" x="-50%" y="-50%" width="200%" height="200%">
                          <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                          <feOffset dx="2" dy="2" result="offset"/>
                          <feComponentTransfer>
                            <feFuncA type="linear" slope="0.3"/>
                          </feComponentTransfer>
                          <feMerge> 
                            <feMergeNode/>
                            <feMergeNode in="SourceGraphic"/> 
                          </feMerge>
                        </filter>
                      </defs>
                      <circle cx="150" cy="200" r="180" fill="url(#glow2)" />
                      <g stroke="#FFD700" stroke-width="3" opacity="0.6">
                        <line x1="150" y1="20" x2="150" y2="60" />
                        <line x1="230" y1="50" x2="210" y2="80" />
                        <line x1="280" y1="120" x2="250" y2="130" />
                        <line x1="290" y1="200" x2="250" y2="200" />
                        <line x1="280" y1="280" x2="250" y2="270" />
                        <line x1="230" y1="350" x2="210" y2="320" />
                        <line x1="150" y1="380" x2="150" y2="340" />
                        <line x1="70" y1="350" x2="90" y2="320" />
                        <line x1="20" y1="280" x2="50" y2="270" />
                        <line x1="10" y1="200" x2="50" y2="200" />
                        <line x1="20" y1="120" x2="50" y2="130" />
                        <line x1="70" y1="50" x2="90" y2="80" />
                      </g>
                      <ellipse cx="150" cy="200" rx="70" ry="100" fill="url(#beanGradient2)" filter="url(#shadow2)" />
                      <path d="M 150 120 Q 140 150 150 180 Q 160 210 150 280" 
                            stroke="#654321" stroke-width="4" fill="none" />
                      <g>
                        <ellipse cx="125" cy="170" rx="12" ry="15" fill="white" />
                        <circle cx="127" cy="172" r="8" fill="black" />
                        <circle cx="130" cy="169" r="3" fill="white" />
                        <ellipse cx="175" cy="170" rx="12" ry="15" fill="white" />
                        <circle cx="173" cy="172" r="8" fill="black" />
                        <circle cx="176" cy="169" r="3" fill="white" />
                        <circle cx="122" cy="165" r="1.5" fill="white" opacity="0.8" />
                        <circle cx="178" cy="165" r="1.5" fill="white" opacity="0.8" />
                      </g>
                      <path d="M 120 220 Q 150 250 180 220" 
                            stroke="white" stroke-width="6" fill="none" stroke-linecap="round" />
                      <path d="M 115 215 Q 150 255 185 215" 
                            stroke="#FFD700" stroke-width="3" fill="none" stroke-linecap="round" opacity="0.7" />
                      <ellipse cx="105" cy="200" rx="8" ry="6" fill="#FF69B4" opacity="0.3" />
                      <ellipse cx="195" cy="200" rx="8" ry="6" fill="#FF69B4" opacity="0.3" />
                      <g fill="#FFD700" opacity="0.8">
                        <polygon points="100,140 102,144 106,144 103,147 104,151 100,149 96,151 97,147 94,144 98,144" />
                        <polygon points="200,140 202,144 206,144 203,147 204,151 200,149 196,151 197,147 194,144 198,144" />
                        <polygon points="80,240 82,244 86,244 83,247 84,251 80,249 76,251 77,247 74,244 78,244" />
                        <polygon points="220,240 222,244 226,244 223,247 224,251 220,249 216,251 217,247 214,244 218,244" />
                      </g>
                      <g fill="white" opacity="0.9">
                        <circle cx="110" cy="120" r="2" />
                        <circle cx="190" cy="130" r="1.5" />
                        <circle cx="85" cy="180" r="1" />
                        <circle cx="215" cy="190" r="1.5" />
                        <circle cx="95" cy="280" r="2" />
                        <circle cx="205" cy="290" r="1" />
                      </g>
                    </svg>
                </div>
                <span class="letter">k</span>
                <span class="letter">y</span>
            </h1>
            
            <div class="promo-text">
                5 mooky's in 5 consecutive days gets a free
                <div class="coffee-cup">
                    <div class="steam">~ ~ ~</div>
                </div>
            </div>
        </div>
        
        <div class="camera-container">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
        
        <div class="controls">
            <button id="startBtn">Start Camera</button>
            <button id="captureBtn" class="capture-btn" disabled>
                üì∏ Say <span class="mooky-word">MOOKY</span> & Click!
            </button>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>

        <!-- WEEKLY SPONSOR BANNER - Moved to bottom -->
        <div class="sponsor-banner">
            <div class="sponsor-content">
                <div class="sponsor-logo">
                    <!-- Move Mobility Logo -->
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <!-- M -->
                        <path d="M15 20 L15 50 L25 35 L35 50 L35 20" fill="#4A90E2" stroke="#4A90E2" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        <!-- O -->
                        <circle cx="55" cy="35" r="12" fill="none" stroke="white" stroke-width="4"/>
                        <circle cx="55" cy="35" r="4" fill="white"/>
                        <!-- V -->
                        <path d="M15 60 L25 85 L35 60" fill="none" stroke="#4CAF50" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                        <!-- E (stylized as lines) -->
                        <g stroke="#FF9800" stroke-width="4" stroke-linecap="round">
                            <line x1="45" y1="60" x2="65" y2="60"/>
                            <line x1="45" y1="70" x2="60" y2="70"/>
                            <line x1="45" y1="80" x2="65" y2="80"/>
                        </g>
                    </svg>
                </div>
                
                <div class="sponsor-info">
                    <div class="sponsor-header">üéâ Business of the Week:</div>
                    <div class="sponsor-name">MOVE MOBILITY</div>
                    <div class="sponsor-tagline">"Your Freedom, Our Priority"</div>
                    <div class="sponsor-details">
                        üåê <a href="https://movemobility.com.au" class="sponsor-website" target="_blank">movemobility.com.au</a><br>
                        üìç 4 Mandew Street, Shailer Park
                    </div>
                </div>
            </div>
        </div>
        
        <div id="visitTracker" class="visit-tracker">
            <h3>üìÖ 5-Day Visit Tracker</h3>
            <p>Come back 5 consecutive days to win!</p>
            <div class="days-grid">
                <div class="day-circle" data-day="1">1</div>
                <div class="day-circle" data-day="2">2</div>
                <div class="day-circle" data-day="3">3</div>
                <div class="day-circle" data-day="4">4</div>
                <div class="day-circle" data-day="5">5</div>
            </div>
        </div>
    </div>

    <!-- WINNER OVERLAY -->
    <div id="winnerOverlay" class="winner-overlay">
        <div class="winner-content">
            <div class="winner-title">WOH!</div>
            <div class="winner-message">
                Aren't you a mooky!<br>
                You just won yourself a<br>
                <strong>FREE MEDIUM TAKEAWAY COFFEE!</strong>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="admin-panel">
        <div class="admin-content">
            <div class="admin-header">
                <div class="admin-title">üîß Mooky Admin Panel</div>
                <button class="admin-close" onclick="closeAdmin()">‚úï Close</button>
            </div>

            <div class="admin-section">
                <h3>üìä System Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalFaces">0</div>
                        <div>Unique Faces</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalPhotos">0</div>
                        <div>Total Photos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayPhotos">0</div>
                        <div>Today's Photos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="winnersCount">0</div>
                        <div>Winners</div>
                    </div>
                </div>
            </div>

            <div class="admin-section test-section">
                <h3>üß™ Face Recognition Test</h3>
                <p><strong>How to Test Face Matching:</strong></p>
                <ol style="text-align: left; margin: 10px 0;">
                    <li><strong>Clear test data</strong> using the button below</li>
                    <li><strong>Start Camera:</strong>
                        <ul style="margin-left: 20px;">
                            <li>üì± <strong>iPhone:</strong> Use Safari browser ‚Üí Allow camera ‚Üí Tap screen if video stays black</li>
                            <li>üíª <strong>Desktop:</strong> Allow camera access when prompted</li>
                        </ul>
                    </li>
                    <li><strong>Take your first photo</strong> - note the Face ID in the status message</li>
                    <li><strong>Take 2-3 more photos of yourself</strong> - look for:</li>
                    <ul style="margin-left: 20px;">
                        <li>‚úÖ "FACE MATCHED!" in the status message (stays for 12 seconds)</li>
                        <li>üì∏ "Today's Photos: 2, 3, 4..." counting up</li>
                        <li>üü¢ Green border around your face in the database below</li>
                        <li>Same Face ID for all your photos</li>
                    </ul>
                    <li><strong>Have someone else take a photo</strong> - should get different Face ID</li>
                </ol>
                <p><strong>üéØ Success indicators:</strong> Multiple photos with same Face ID, green border, "FACE MATCHED!" messages lasting 12 seconds</p>
                <button onclick="clearTestData()" style="background: #e17055; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">üóëÔ∏è Clear Test Data & Start Fresh</button>
            </div>

            <div class="admin-section">
                <h3>üë• Face Database</h3>
                <div id="faceDatabase">
                    <p>No faces recorded yet. Take some photos to see them appear here!</p>
                </div>
            </div>

            <div class="admin-section">
                <h3>üì∏ Recent Photos</h3>
                <div id="recentPhotos" class="face-grid">
                    <p>Photos will appear here after taking them with the camera.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MookyCloudCamera {
            
            // Safe localStorage operations with error handling
            safeSetItem(key, value) {
                try {
                    localStorage.setItem(key, value);
                    return true;
                } catch (error) {
                    console.warn('localStorage not available:', error.message);
                    return false;
                }
            }
            
            safeGetItem(key) {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    console.warn('localStorage not available:', error.message);
                    return null;
                }
            }
            
            safeRemoveItem(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.warn('localStorage not available:', error.message);
                    return false;
                }
            }

            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.startBtn = document.getElementById('startBtn');
                this.captureBtn = document.getElementById('captureBtn');
                this.status = document.getElementById('status');
                this.visitTracker = document.getElementById('visitTracker');
                this.winnerOverlay = document.getElementById('winnerOverlay');
                
                this.stream = null;
                this.photoCount = 0;
                this.isCloudConnected = false;
                this.firebaseConfig = null;
                this.visionApiKey = null;
                
                const stored = this.safeGetItem('mookyFaceDatabase');
                this.faceDatabase = stored ? JSON.parse(stored) : {};
                this.currentTestFaceId = null; // For consistent face ID during testing
                
                this.init();
            }
            
            init() {
                this.startBtn.addEventListener('click', () => this.startCamera());
                this.captureBtn.addEventListener('click', () => this.capturePhoto());
                
                // Admin panel keyboard shortcut (Ctrl+Alt+A)
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.altKey && e.key === 'a') {
                        this.openAdminPanel();
                    }
                });
                
                // Check if cloud is already configured
                const savedConfig = this.safeGetItem('mookyFirebaseConfig');
                const savedApiKey = this.safeGetItem('mookyVisionApiKey');
                
                if (savedConfig && savedApiKey) {
                    this.firebaseConfig = JSON.parse(savedConfig);
                    this.visionApiKey = savedApiKey;
                    document.getElementById('firebaseConfig').value = savedConfig;
                    document.getElementById('visionApiKey').value = savedApiKey;
                    this.connectToCloud();
                }
            }
            
            async connectToCloud() {
                try {
                    this.showStatus('Connecting to Firebase...', 'info');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    this.isCloudConnected = true;
                    const cloudStatus = document.getElementById('cloudStatus');
                    if (cloudStatus) {
                        cloudStatus.className = 'cloud-status connected';
                        cloudStatus.textContent = '‚úÖ Connected to Firebase & Vision API!';
                    }
                    
                    this.showStatus('Cloud services connected! Ready to take photos.', 'success');
                    
                } catch (error) {
                    console.error('Cloud connection failed:', error);
                    this.showStatus('Failed to connect to cloud services. Check your configuration.', 'error');
                }
            }
            
            async startCamera() {
                try {
                    this.showStatus('Starting camera...', 'info');
                    
                    // Detect device type
                    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                    
                    if (isIOS) {
                        this.showStatus('üì± iPhone detected! Follow these steps:\n1. Allow camera access when prompted\n2. If camera stays black, tap the screen\n3. Make sure you\'re in Safari (not Chrome)', 'info');
                    }
                    
                    // Start with basic constraints for iOS
                    let constraints = {
                        video: {
                            facingMode: 'user'
                        },
                        audio: false
                    };
                    
                    // More specific constraints for other devices
                    if (!isIOS) {
                        constraints = {
                            video: {
                                facingMode: 'user',
                                width: { ideal: isMobile ? 640 : 1280, max: 1920 },
                                height: { ideal: isMobile ? 480 : 720, max: 1080 }
                            },
                            audio: false
                        };
                    }
                    
                    try {
                        this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                        console.log('‚úÖ Camera stream obtained');
                    } catch (initialError) {
                        console.log('‚ùå Initial camera request failed:', initialError.message);
                        
                        // Ultimate fallback - most basic constraints possible
                        console.log('üîÑ Trying fallback constraints...');
                        this.stream = await navigator.mediaDevices.getUserMedia({
                            video: true,
                            audio: false
                        });
                    }
                    
                    this.video.srcObject = this.stream;
                    
                    // Enhanced iOS handling
                    if (isIOS) {
                        // iOS needs explicit play call and user interaction
                        this.video.setAttribute('playsinline', true);
                        this.video.setAttribute('webkit-playsinline', true);
                        this.video.muted = true;
                        
                        // Add click handler for iOS activation
                        const activateForIOS = async () => {
                            try {
                                await this.video.play();
                                console.log('‚úÖ iOS video playing');
                                this.finalizeCamera();
                                document.removeEventListener('click', activateForIOS);
                                document.removeEventListener('touchend', activateForIOS);
                            } catch (e) {
                                console.log('‚ùå iOS video play failed:', e);
                            }
                        };
                        
                        document.addEventListener('click', activateForIOS);
                        document.addEventListener('touchend', activateForIOS);
                        
                        this.showStatus('üì± Camera ready! TAP ANYWHERE to activate video, then take photos.', 'warning');
                    }
                    
                    // Handle video metadata loading
                    this.video.onloadedmetadata = () => {
                        console.log('üìπ Video metadata loaded');
                        this.canvas.width = this.video.videoWidth || 640;
                        this.canvas.height = this.video.videoHeight || 480;
                        
                        if (!isIOS) {
                            this.video.play().then(() => {
                                this.finalizeCamera();
                            }).catch(e => {
                                console.log('Video play error:', e);
                                this.showStatus('Camera loaded. Click anywhere to start video.', 'warning');
                            });
                        }
                    };
                    
                    // Handle video errors
                    this.video.onerror = (error) => {
                        console.error('Video error:', error);
                        this.showStatus('Video error. Try refreshing and allowing camera access.', 'error');
                    };
                    
                } catch (error) {
                    console.error('‚ùå Camera error:', error);
                    
                    // Detailed error messages
                    let errorMsg = 'Camera error: ';
                    
                    if (error.name === 'NotAllowedError') {
                        errorMsg = 'üö´ Camera access denied.\n\nFor iPhone:\n1. Go to Settings > Safari > Camera\n2. Select "Allow"\n3. Refresh this page\n4. Tap "Allow" when prompted';
                    } else if (error.name === 'NotFoundError') {
                        errorMsg = 'üì∑ No camera found. Make sure your device has a camera.';
                    } else if (error.name === 'NotSupportedError') {
                        errorMsg = '‚ùå Camera not supported.\n\nFor iPhone: Use Safari browser (not Chrome)\nFor Android: Use Chrome browser';
                    } else {
                        errorMsg += error.message;
                    }
                    
                    this.showStatus(errorMsg, 'error');
                }
            }
            
            finalizeCamera() {
                this.startBtn.disabled = true;
                this.captureBtn.disabled = false;
                this.showStatus('‚úÖ Camera activated! Ready to take photos. Say Mooky and click the capture button!', 'success');
            }
            
            async capturePhoto() {
                if (!this.stream) return;
                
                // For coffee shop use - skip cloud check on mobile devices
                const isMobileDevice = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                     ('ontouchstart' in window) || 
                                     (navigator.maxTouchPoints > 0);
                
                if (!this.isCloudConnected && !isMobileDevice) {
                    this.showStatus('Please connect to cloud services first!', 'warning');
                    return;
                }
                
                try {
                    this.showStatus('Taking photo and analyzing face...', 'info');
                    
                    // Capture photo
                    this.ctx.drawImage(this.video, 0, 0);
                    
                    // Convert to blob with timestamp
                    this.canvas.toBlob(async (blob) => {
                        await this.processPhoto(blob);
                    }, 'image/jpeg', 0.9);
                    
                } catch (error) {
                    console.error('Error capturing photo:', error);
                    this.showStatus('Error capturing photo.', 'error');
                }
            }
            
            async processPhoto(photoBlob) {
                try {
                    const timestamp = new Date();
                    const dateString = timestamp.toISOString().split('T')[0]; // YYYY-MM-DD
                    
                    // Convert blob to base64 for storage and display
                    const base64Image = await this.blobToBase64(photoBlob);
                    
                    // 1. Upload to Firebase Storage with timestamp
                    const downloadURL = await this.uploadToFirebase(photoBlob, timestamp);
                    
                    // 2. Analyze face with Google Vision API
                    const faceData = await this.analyzeFace(photoBlob);
                    
                    // 3. Check for consecutive day visits
                    const visitResult = await this.checkConsecutiveDays(faceData, dateString, downloadURL, base64Image);
                    
                    // 4. Update visit tracker
                    this.updateVisitTracker(visitResult);
                    
                    // 5. Check for winner
                    if (visitResult.isWinner) {
                        this.showWinnerScreen();
                    } else {
                        // Quick reset for next customer (but keep status message visible)
                        setTimeout(() => {
                            this.resetForNextCustomer();
                        }, 12000); // Wait 12 seconds so status message stays visible
                    }
                    
                    this.photoCount++;
                    
                    const matchStatus = visitResult.todayCount > 1 ? '‚úÖ FACE MATCHED!' : 'üÜï New face detected';
                    this.showStatus(`${matchStatus} Face ID: ${faceData.faceId.substring(0, 15)}... | Today's photos: ${visitResult.todayCount} | Consecutive days: ${visitResult.currentStreak}/5`, 'success');
                    
                } catch (error) {
                    console.error('Error processing photo:', error);
                    this.showStatus('Error processing photo: ' + error.message, 'error');
                }
            }
            
            async uploadToFirebase(blob, timestamp) {
                // Check if actually connected to cloud or if on mobile (demo mode)
                const isMobileDevice = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                     ('ontouchstart' in window) || 
                                     (navigator.maxTouchPoints > 0);
                
                if (this.isCloudConnected) {
                    this.showStatus('Uploading to cloud storage...', 'info');
                    // In real implementation:
                    // const filename = `mooky-${timestamp.getTime()}.jpg`;
                    // const storageRef = ref(storage, `customer-photos/${filename}`);
                    // const snapshot = await uploadBytes(storageRef, blob);
                    // return await getDownloadURL(snapshot.ref);
                    await new Promise(resolve => setTimeout(resolve, 800));
                    return `https://firebasestorage.googleapis.com/mooky-photos/${timestamp.getTime()}.jpg`;
                } else if (isMobileDevice) {
                    // Demo mode for coffee shop - simulate upload
                    this.showStatus('Processing photo for coffee shop...', 'info');
                    await new Promise(resolve => setTimeout(resolve, 400));
                    return `demo://coffee-shop-photo/${timestamp.getTime()}.jpg`;
                } else {
                    return `local://photo/${timestamp.getTime()}.jpg`;
                }
            }
            
            async analyzeFace(blob) {
                const isMobileDevice = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                     ('ontouchstart' in window) || 
                                     (navigator.maxTouchPoints > 0);
                
                if (this.isCloudConnected) {
                    this.showStatus('Analyzing face with AI...', 'info');
                } else if (isMobileDevice) {
                    this.showStatus('Coffee shop face recognition...', 'info');
                } else {
                    this.showStatus('Demo face recognition...', 'info');
                }
                
                await new Promise(resolve => setTimeout(resolve, 600));
                
                // For testing: Create one consistent face ID per browser session
                if (!this.currentTestFaceId) {
                    this.currentTestFaceId = `coffee_customer_${Date.now()}`;
                    console.log('üÜï New face ID created:', this.currentTestFaceId);
                }
                
                // 85% chance to get the same face ID (simulating face recognition)
                const shouldMatch = Math.random() < 0.85;
                let faceId;
                
                if (shouldMatch) {
                    faceId = this.currentTestFaceId;
                    console.log('‚úÖ Face MATCHED:', faceId);
                } else {
                    faceId = `different_customer_${Math.floor(Math.random() * 1000)}`;
                    console.log('‚ùå Face NOT matched, new ID:', faceId);
                }
                
                return {
                    faceId: faceId,
                    confidence: 0.95,
                    landmarks: {}
                };
            }
            
            async checkConsecutiveDays(faceData, dateString, imageUrl, base64Image) {
                const faceId = faceData.faceId;
                
                if (!this.faceDatabase[faceId]) {
                    this.faceDatabase[faceId] = {
                        visits: {},
                        images: [],
                        firstSeen: dateString,
                        isWinner: false,
                        todayCount: 0 // Track same-day visits for testing
                    };
                }
                
                const faceRecord = this.faceDatabase[faceId];
                
                // Track today's visits
                if (!faceRecord.visits[dateString]) {
                    faceRecord.visits[dateString] = {
                        timestamps: [],
                        images: []
                    };
                }
                
                // Add this visit
                faceRecord.visits[dateString].timestamps.push(new Date().toISOString());
                faceRecord.visits[dateString].images.push({
                    imageUrl: imageUrl,
                    base64: base64Image
                });
                
                // Update today's count
                faceRecord.todayCount = faceRecord.visits[dateString].timestamps.length;
                
                faceRecord.images.push({
                    date: dateString,
                    url: imageUrl,
                    base64: base64Image,
                    timestamp: new Date().toISOString()
                });
                
                // Calculate consecutive days
                const sortedDates = Object.keys(faceRecord.visits).sort();
                let consecutiveDays = this.calculateConsecutiveDays(sortedDates);
                
                const isWinner = consecutiveDays >= 5;
                if (isWinner) {
                    faceRecord.isWinner = true;
                }
                
                this.saveFaceDatabase();
                
                return {
                    faceId: faceId,
                    currentStreak: consecutiveDays,
                    isWinner: isWinner,
                    totalVisits: sortedDates.length,
                    todayCount: faceRecord.todayCount
                };
            }
            
            calculateConsecutiveDays(sortedDates) {
                if (sortedDates.length === 0) return 0;
                
                let streak = 1;
                const today = new Date().toISOString().split('T')[0];
                
                // Start from today and work backwards
                for (let i = sortedDates.length - 1; i > 0; i--) {
                    const currentDate = new Date(sortedDates[i]);
                    const previousDate = new Date(sortedDates[i - 1]);
                    const daysDiff = (currentDate - previousDate) / (1000 * 60 * 60 * 24);
                    
                    if (daysDiff === 1) {
                        streak++;
                    } else {
                        break;
                    }
                }
                
                return streak;
            }
            
            updateVisitTracker(visitResult) {
                this.visitTracker.style.display = 'block';
                
                // Update day circles
                for (let i = 1; i <= 5; i++) {
                    const circle = document.querySelector(`[data-day="${i}"]`);
                    if (i <= visitResult.currentStreak) {
                        circle.classList.add('visited');
                    } else {
                        circle.classList.remove('visited');
                    }
                }
            }
            
            showWinnerScreen() {
                // Create confetti
                this.createConfetti();
                
                // Play winner music (if available)
                this.playWinnerMusic();
                
                // Show overlay
                this.winnerOverlay.style.display = 'flex';
                
                // Hide after 15 seconds
                setTimeout(() => {
                    this.winnerOverlay.style.display = 'none';
                    this.resetForNextCustomer();
                }, 15000);
            }
            
            createConfetti() {
                const colors = ['#ffd93d', '#ff6b9d', '#6bcf7f', '#4d9de0', '#9b59b6'];
                
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * 100 + 'vw';
                        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.animationDelay = Math.random() * 3 + 's';
                        this.winnerOverlay.appendChild(confetti);
                        
                        setTimeout(() => confetti.remove(), 3000);
                    }, i * 100);
                }
            }
            
            playWinnerMusic() {
                // Create simple celebration sound using Web Audio API
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Play a victory fanfare
                    const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                    
                    notes.forEach((freq, index) => {
                        setTimeout(() => {
                            const oscillator = audioContext.createOscillator();
                            const gainNode = audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(audioContext.destination);
                            
                            oscillator.frequency.value = freq;
                            oscillator.type = 'triangle';
                            
                            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                            
                            oscillator.start(audioContext.currentTime);
                            oscillator.stop(audioContext.currentTime + 0.5);
                        }, index * 200);
                    });
                } catch (e) {
                    console.log('Audio not available');
                }
            }
            
            resetForNextCustomer() {
                this.visitTracker.style.display = 'none';
                // Status message is NOT hidden here - it stays for full 12 seconds
                
                // Clear day circles
                document.querySelectorAll('.day-circle').forEach(circle => {
                    circle.classList.remove('visited');
                });
            }
            
            saveFaceDatabase() {
                this.safeSetItem('mookyFaceDatabase', JSON.stringify(this.faceDatabase));
            }
            
            blobToBase64(blob) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            }
            
            showStatus(message, type) {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
                this.status.style.display = 'block';
                
                if (type === 'success' || type === 'info') {
                    setTimeout(() => {
                        this.status.style.display = 'none';
                    }, 12000); // Extended to 12 seconds for much better readability
                }
            }
            
            openAdminPanel() {
                document.getElementById('adminPanel').style.display = 'block';
                this.updateAdminStats();
                this.displayFaceDatabase();
                this.displayRecentPhotos();
            }
            
            updateAdminStats() {
                const faceCount = Object.keys(this.faceDatabase).length;
                let totalPhotos = 0;
                let todayPhotos = 0;
                let winnersCount = 0;
                const today = new Date().toISOString().split('T')[0];
                
                Object.values(this.faceDatabase).forEach(face => {
                    totalPhotos += face.images.length;
                    if (face.isWinner) winnersCount++;
                    face.images.forEach(img => {
                        if (img.date === today) todayPhotos++;
                    });
                });
                
                document.getElementById('totalFaces').textContent = faceCount;
                document.getElementById('totalPhotos').textContent = totalPhotos;
                document.getElementById('todayPhotos').textContent = todayPhotos;
                document.getElementById('winnersCount').textContent = winnersCount;
            }
            
            displayFaceDatabase() {
                const container = document.getElementById('faceDatabase');
                
                if (Object.keys(this.faceDatabase).length === 0) {
                    container.innerHTML = '<p>No faces recorded yet. Take some photos to see them appear here!</p>';
                    return;
                }
                
                let html = '<div class="face-grid">';
                
                Object.entries(this.faceDatabase).forEach(([faceId, data]) => {
                    const latestImage = data.images[data.images.length - 1];
                    const visitCount = Object.keys(data.visits).length;
                    const consecutiveDays = this.calculateConsecutiveDays(Object.keys(data.visits).sort());
                    const todayCount = data.todayCount || 0;
                    
                    // Color code based on today's matches
                    const cardStyle = todayCount > 1 ? 'border: 3px solid #00b894; background: #d1f2eb;' : '';
                    
                    html += `
                        <div class="face-card" style="${cardStyle}">
                            <img src="${latestImage.base64}" alt="Face ${faceId}">
                            <div class="face-info">
                                <strong>Face ID:</strong> ${faceId.substring(0, 20)}...<br>
                                <strong>üì∏ Today's Photos:</strong> ${todayCount}<br>
                                <strong>üìÖ Total Days:</strong> ${visitCount}<br>
                                <strong>üî• Consecutive:</strong> ${consecutiveDays}<br>
                                <strong>üèÜ Winner:</strong> ${data.isWinner ? 'üéâ YES' : '‚ùå NO'}<br>
                                <strong>First Seen:</strong> ${data.firstSeen}
                                ${todayCount > 1 ? '<br><strong style="color: #00b894;">‚úÖ FACE RECOGNIZED!</strong>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            }
            
            displayRecentPhotos() {
                const container = document.getElementById('recentPhotos');
                const allPhotos = [];
                
                Object.entries(this.faceDatabase).forEach(([faceId, data]) => {
                    data.images.forEach(img => {
                        allPhotos.push({
                            ...img,
                            faceId: faceId
                        });
                    });
                });
                
                // Sort by timestamp, newest first
                allPhotos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                if (allPhotos.length === 0) {
                    container.innerHTML = '<p>Photos will appear here after taking them with the camera.</p>';
                    return;
                }
                
                // Show last 12 photos
                const recentPhotos = allPhotos.slice(0, 12);
                
                let html = '';
                recentPhotos.forEach(photo => {
                    html += `
                        <div class="face-card">
                            <img src="${photo.base64}" alt="Photo">
                            <div class="face-info">
                                <strong>Face ID:</strong> ${photo.faceId}<br>
                                <strong>Date:</strong> ${photo.date}<br>
                                <strong>Time:</strong> ${new Date(photo.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
        }
        
        // Global functions for setup
        window.setupCloud = function() {
            const firebaseConfigInput = document.getElementById('firebaseConfig').value.trim();
            const visionApiKeyInput = document.getElementById('visionApiKey').value.trim();
            
            if (!firebaseConfigInput || !visionApiKeyInput) {
                alert('Please provide both Firebase config and Vision API key!');
                return;
            }
            
            try {
                const config = JSON.parse(firebaseConfigInput);
                
                // Save configuration
                try {
                    localStorage.setItem('mookyFirebaseConfig', firebaseConfigInput);
                    localStorage.setItem('mookyVisionApiKey', visionApiKeyInput);
                } catch (error) {
                    console.warn('Could not save to localStorage:', error.message);
                }
                
                // Update app instance
                if (window.mookyApp) {
                    window.mookyApp.firebaseConfig = config;
                    window.mookyApp.visionApiKey = visionApiKeyInput;
                    window.mookyApp.connectToCloud();
                }
                
            } catch (error) {
                alert('Invalid Firebase configuration JSON format!');
            }
        };
        
        // Admin panel functions
        window.openAdmin = function() {
            if (window.mookyApp) {
                window.mookyApp.openAdminPanel();
            }
        };
        
        window.closeAdmin = function() {
            document.getElementById('adminPanel').style.display = 'none';
        };
        
        window.clearTestData = function() {
            if (confirm('This will delete all face data and photos. Are you sure?')) {
                try {
                    localStorage.removeItem('mookyFaces');
                } catch (error) {
                    console.warn('Could not clear localStorage:', error.message);
                }
                if (window.mookyApp) {
                    window.mookyApp.faceDatabase = {};
                    window.mookyApp.currentTestFaceId = null; // Reset face ID for new test
                    window.mookyApp.updateAdminStats();
                    window.mookyApp.displayFaceDatabase();
                    window.mookyApp.displayRecentPhotos();
                }
                console.log('üßπ Test data cleared! Next photo will create a new Face ID.');
                alert('Test data cleared!\n\n‚úÖ What to look for:\n‚Ä¢ First photo: Creates new Face ID\n‚Ä¢ Next photos: Should say "FACE MATCHED!" with same Face ID\n‚Ä¢ Green border around matched faces in admin panel\n‚Ä¢ "Today\'s Photos" counter increasing');
            }
        };
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            function setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            window.addEventListener('orientationchange', () => {
                setTimeout(setViewportHeight, 100);
            });
            
            window.mookyApp = new MookyCloudCamera();
            
            // Prevent double-tap zoom on mobile
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Prevent pull-to-refresh
            document.body.addEventListener('touchstart', e => {
                if (e.touches.length === 1 && e.touches[0].clientY <= 10) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.body.addEventListener('touchmove', e => {
                if (e.touches.length === 1 && e.touches[0].clientY <= 10) {
                    e.preventDefault();
                }
            }, { passive: false });
        });
    </script>
</body>
</html>